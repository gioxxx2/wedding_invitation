name: Deploy to Tencent Cloud COS

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Tencent COS (excluding video)
        uses: zkqiang/tencent-cos-action@v0.1.0
        with:
          args: upload -rs ./ cos://wedding-1303923554/ --ignore '.*\.git.*|^video/.*'
          secret_id: ${{ secrets.TENCENT_SECRET_ID }}
          secret_key: ${{ secrets.TENCENT_SECRET_KEY }}
          bucket: wedding-1303923554
          region: ap-guangzhou

      - name: Deploy video files with retry
        env:
          SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
          SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
        run: |
          # å®‰è£…Pythonå’ŒCOS SDK
          pip3 install cos-python-sdk-v5
          
          # ä½¿ç”¨Pythonè„šæœ¬ä¸Šä¼ è§†é¢‘æ–‡ä»¶ï¼Œå¸¦é‡è¯•æœºåˆ¶
          python3 << 'EOF'
          from qcloud_cos import CosConfig
          from qcloud_cos import CosS3Client
          import os
          import time
          
          secret_id = os.environ['SECRET_ID']
          secret_key = os.environ['SECRET_KEY']
          region = 'ap-guangzhou'
          bucket = 'wedding-1303923554'
          
          config = CosConfig(
              Region=region, 
              SecretId=secret_id, 
              SecretKey=secret_key,
              Timeout=300,  # å¢åŠ è¶…æ—¶æ—¶é—´åˆ°5åˆ†é’Ÿ
              ChunkSize=10 * 1024 * 1024,  # 10MBåˆ†ç‰‡
              MaxThread=5  # å¤šçº¿ç¨‹ä¸Šä¼ 
          )
          client = CosS3Client(config)
          
          # ä¸Šä¼ è§†é¢‘æ–‡ä»¶ï¼Œå¸¦é‡è¯•æœºåˆ¶
          video_file = 'video/å¾æ™ºè¯·æŸ¬æ— æ°´å°ï¼ˆ2ï¼‰.mp4'
          max_retries = 3
          
          if os.path.exists(video_file):
              for attempt in range(max_retries):
                  try:
                      print(f"ğŸ“¤ å°è¯•ä¸Šä¼ è§†é¢‘æ–‡ä»¶ (ç¬¬ {attempt + 1}/{max_retries} æ¬¡)...")
                      response = client.upload_file(
                          Bucket=bucket,
                          LocalFilePath=video_file,
                          Key=video_file,
                          PartSize=10 * 1024 * 1024,  # 10MBåˆ†ç‰‡
                          MAXThread=5,  # 5ä¸ªçº¿ç¨‹å¹¶å‘ä¸Šä¼ 
                          EnableMD5=False
                      )
                      print(f"âœ… è§†é¢‘æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼ETag: {response.get('ETag', 'N/A')}")
                      break
                  except Exception as e:
                      print(f"âŒ ç¬¬ {attempt + 1} æ¬¡ä¸Šä¼ å¤±è´¥: {e}")
                      if attempt < max_retries - 1:
                          wait_time = (attempt + 1) * 30  # ç­‰å¾…æ—¶é—´é€’å¢ï¼š30ç§’ã€60ç§’ã€90ç§’
                          print(f"â³ ç­‰å¾… {wait_time} ç§’åé‡è¯•...")
                          time.sleep(wait_time)
                      else:
                          print(f"âš ï¸ è§†é¢‘æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œå·²é‡è¯• {max_retries} æ¬¡")
                          print("ğŸ’¡ æç¤ºï¼šè§†é¢‘æ–‡ä»¶è¾ƒå¤§ï¼Œå¯ä»¥ç¨åæ‰‹åŠ¨ä¸Šä¼ æˆ–ä½¿ç”¨å…¶ä»–æ–¹å¼ä¸Šä¼ ")
          else:
              print(f"â„¹ï¸ è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨: {video_file}")
          EOF

      - name: Set Content-Type for files
        env:
          SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
          SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
        run: |
          # å®‰è£…Pythonå’ŒCOS SDK
          pip3 install cos-python-sdk-v5
          
          # ä½¿ç”¨Pythonè„šæœ¬è®¾ç½®Content-Type
          python3 << 'EOF'
          from qcloud_cos import CosConfig
          from qcloud_cos import CosS3Client
          import os
          
          secret_id = os.environ['SECRET_ID']
          secret_key = os.environ['SECRET_KEY']
          region = 'ap-guangzhou'
          bucket = 'wedding-1303923554'
          
          config = CosConfig(Region=region, SecretId=secret_id, SecretKey=secret_key)
          client = CosS3Client(config)
          
          # è®¾ç½®æ–‡ä»¶Content-Typeçš„æ˜ å°„
          content_types = {
              'index.html': 'text/html; charset=utf-8',
              'data-viewer.html': 'text/html; charset=utf-8',
              'styles.css': 'text/css; charset=utf-8',
              'script.js': 'application/javascript; charset=utf-8'
          }
          
          for file, content_type in content_types.items():
              try:
                  # è·å–æ–‡ä»¶å…ƒæ•°æ®
                  response = client.head_object(Bucket=bucket, Key=file)
                  # å¤åˆ¶å¯¹è±¡å¹¶æ›¿æ¢å…ƒæ•°æ®
                  client.copy_object(
                      Bucket=bucket,
                      Key=file,
                      CopySource={'Bucket': bucket, 'Key': file, 'Region': region},
                      MetadataDirective='REPLACE',
                      ContentType=content_type
                  )
                  print(f"âœ… å·²è®¾ç½® {file} çš„Content-Typeä¸º {content_type}")
              except Exception as e:
                  print(f"âš ï¸ è®¾ç½® {file} å¤±è´¥: {e}")
          EOF

      - name: Deploy Summary
        run: |
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "è®¿é—®åœ°å€: https://wedding-1303923554.cos-website.ap-guangzhou.myqcloud.com"
