name: Deploy to Tencent Cloud COS

on:
  push:
    branches:
      - main
  workflow_dispatch: # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Tencent COS
        uses: zkqiang/tencent-cos-action@v0.1.0
        with:
          args: upload -rs ./ cos://wedding-1303923554/ --ignore '.*\.git.*'
          secret_id: ${{ secrets.TENCENT_SECRET_ID }}
          secret_key: ${{ secrets.TENCENT_SECRET_KEY }}
          bucket: wedding-1303923554
          region: ap-guangzhou

      - name: Set Content-Type for files
        env:
          SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
          SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
        run: |
          # 安装Python和COS SDK
          pip3 install cos-python-sdk-v5
          
          # 使用Python脚本设置Content-Type
          python3 << 'EOF'
          from qcloud_cos import CosConfig
          from qcloud_cos import CosS3Client
          import os
          
          secret_id = os.environ['SECRET_ID']
          secret_key = os.environ['SECRET_KEY']
          region = 'ap-guangzhou'
          bucket = 'wedding-1303923554'
          
          config = CosConfig(Region=region, SecretId=secret_id, SecretKey=secret_key)
          client = CosS3Client(config)
          
          # 设置文件Content-Type的映射
          content_types = {
              'index.html': 'text/html; charset=utf-8',
              'data-viewer.html': 'text/html; charset=utf-8',
              'styles.css': 'text/css; charset=utf-8',
              'script.js': 'application/javascript; charset=utf-8'
          }
          
          for file, content_type in content_types.items():
              try:
                  # 获取文件元数据
                  response = client.head_object(Bucket=bucket, Key=file)
                  # 复制对象并替换元数据
                  client.copy_object(
                      Bucket=bucket,
                      Key=file,
                      CopySource={'Bucket': bucket, 'Key': file, 'Region': region},
                      MetadataDirective='REPLACE',
                      ContentType=content_type
                  )
                  print(f"✅ 已设置 {file} 的Content-Type为 {content_type}")
              except Exception as e:
                  print(f"⚠️ 设置 {file} 失败: {e}")
          EOF

      - name: Deploy Summary
        run: |
          echo "✅ 部署完成！"
          echo "访问地址: https://wedding-1303923554.cos-website.ap-guangzhou.myqcloud.com"
